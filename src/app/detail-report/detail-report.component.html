<app-header></app-header>
<app-aside></app-aside>

<main id="main" class="main py-5" style="background-color: #f4f6f9;">
  <div class="container mt-4">
    <!-- Page Header -->
    <div id="rapportContent">
      <div class="text-center mb-5">
        <h2 class="fw-bold text-primary">Maintenance Report</h2>
        <p class="text-muted">Review detailed information about the preventive intervention.</p>
      </div>

      <!-- Print & Export Buttons -->
      <div class="d-flex justify-content-end mb-3" id="buttons">
        <button class="btn btn-lg btn-primary me-2 btn-animate" (click)="printPage()">Print</button>
        <button class="btn btn-danger btn-lg" (click)="exportToPDF()">Export PDF</button>
      </div>

      <!-- Loading Indicator -->
      <div *ngIf="isLoading" class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Loading report...</p>
      </div>

      <!-- Site Information -->
      <div *ngIf="rapport.report?.site" class="card shadow-sm mb-4 report-block animate__animated animate__fadeInUp">
        <div class="card-header bg-primary text-white fw-semibold">Site Information</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="d-flex">
                <div class="info-label">Name:</div>
                <div class="info-value">{{ rapport.report.site.name }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <div class="info-label">Region / Province:</div>
                <div class="info-value">{{ rapport.report.site.region }} / {{ rapport.report.site.province }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <div class="info-label">Coordinates:</div>
                <div class="info-value">{{ rapport.report.site.latitude }}, {{ rapport.report.site.longitude }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <div class="info-label">Tenants:</div>
                <div class="info-value">{{ rapport.report.site.tenantsNames }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <div class="info-label">Portfolio:</div>
                <div class="info-value">{{ rapport.report.site.portfolio }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <div class="info-label">Power Configuration:</div>
                <div class="info-value">{{ rapport.report.site.powerConfiguration }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <div class="info-label">Site Type:</div>
                <div class="info-value">{{ rapport.report.site.siteType }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Data -->
      <div *ngIf="rapport.report" class="card shadow-sm mb-4 report-block animate__animated animate__fadeInUp animate__delay-1s">
        <div class="card-header bg-secondary text-white fw-semibold">Report Data</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="d-flex">
                <div class="info-label">FME:</div>
                <div class="info-value">{{ rapport.report.fmeName }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex">
                <div class="info-label">Scheduled PM:</div>
                <div class="info-value">{{ rapport.report.pmPlannedDate | date:'mediumDate' }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex">
                <div class="info-label">Performed PM:</div>
                <div class="info-value">{{ rapport.report.pmActualDate | date:'mediumDate' }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex">
                <div class="info-label">PM Type:</div>
                <div class="info-value">{{ rapport.report.pmType }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex">
                <div class="info-label">Status:</div>
                <div class="info-value">
                  <span class="badge bg-success px-3 py-2 text-uppercase">{{ rapport.report.status }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sections -->
      <ng-container *ngIf="rapport.report?.sections?.length">
        <div *ngFor="let section of rapport.report.sections" class="card shadow-sm mb-4 report-block animate__animated animate__fadeInUp animate__delay-2s">
          <div class="card-header bg-dark text-white fw-semibold">{{ section.title }}</div>
          <div class="card-body">
            <div class="d-flex mb-3">
              <div class="info-label">Reported Issue:</div>
              <div class="info-value">
                <span *ngIf="section.hasIssue" class="badge bg-danger ms-2">Yes</span>
                <span *ngIf="!section.hasIssue" class="badge bg-success ms-2">No</span>
              </div>
            </div>
            <hr />

            <!-- Items -->
            <div *ngFor="let item of section.items" class="mb-4 item-container">
              <h6 class="item-title">{{ item.label }}</h6>

              <!-- Values (showing only the most recent) -->
              <div *ngIf="getLatestValue(item.id) as value" class="item-value-container">
                <div class="d-flex">
                  <div class="info-value">{{ value.value }}</div>
                </div>
                <div *ngIf="value.comment" class="item-comment">
                  <em>Comment:</em> {{ value.comment }}
                </div>
              </div>

              <!-- Images -->
              <div class="row mt-3">
                <ng-container *ngFor="let photo of getItemPhotos(item.id)">
                  <div class="col-md-4 mb-3">
                    <div class="photo-container">
                      <img [src]="photo.url || photo.base64Image" class="img-fluid rounded border img-hover" [alt]="'Photo ' + item.label" />
                      <small *ngIf="photo.comment" class="photo-comment mt-2">{{ photo.comment }}</small>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- No sections -->
      <div *ngIf="!rapport.report?.sections?.length" class="alert alert-warning">
        No sections available for this report.
      </div>
    </div>
  </div>
</main>

<app-footer></app-footer>
