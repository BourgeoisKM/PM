<app-header></app-header>
<app-aside></app-aside>

<main id="main" class="main modern-reports-page" data-aos="fade-in" data-aos-duration="700">
  
  <!-- Hero Section -->
  <div class="hero-section mb-5" data-aos="fade-down" data-aos-duration="800">
    <div class="hero-content">
      <div class="hero-text">
        <h1 class="hero-title">
          <i class="bi bi-clipboard-data me-3"></i>
          Reports Dashboard
        </h1>
        <p class="hero-subtitle">
          Manage and monitor all maintenance reports in real-time
        </p>
      </div>
      <div class="hero-stats" *ngIf="!initialLoading">
        <div class="stat-card">
          <div class="stat-number">{{ totalItems }}</div>
          <div class="stat-label">Total Reports</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ totalPages }}</div>
          <div class="stat-label">Pages</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner for Initial Load -->
  <div *ngIf="initialLoading && showSkeleton" class="loading-container">
    <div class="modern-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
    <p class="loading-text">Loading reports...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger modern-alert" data-aos="fade-up">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <span>{{ error }}</span>
  </div>

  <!-- Controls Section -->
  <div *ngIf="!initialLoading" class="controls-section mb-4" data-aos="fade-up">
    
    <!-- Search and Export Row -->
    <div class="row mb-4">
      <div class="col-lg-6">
        <div class="search-container">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="form-control search-input"
            placeholder="Search by site name, agent, vendor..."
            [(ngModel)]="searchTerm"
            (input)="applySearch()"
          />
          <button *ngIf="searchTerm" class="clear-search" (click)="searchTerm = ''; applySearch()">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>
      <div class="col-lg-6 text-end">
        <button (click)="exportExcel()" class="btn btn-export">
          <i class="bi bi-file-earmark-excel me-2"></i>
          Export Excel
        </button>
      </div>
    </div>

    <!-- Filters Row -->
    <div class="filters-container">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="startDate" class="form-label">
            <i class="bi bi-calendar-event me-1"></i> Start Date
          </label>
          <input type="date" id="startDate" [(ngModel)]="filterStartDate" class="form-control modern-input" />
        </div>
        <div class="col-md-3">
          <label for="endDate" class="form-label">
            <i class="bi bi-calendar-event me-1"></i> End Date
          </label>
          <input type="date" id="endDate" [(ngModel)]="filterEndDate" class="form-control modern-input" />
        </div>
        <div class="col-auto">
          <button class="btn btn-primary modern-btn" (click)="applyDateFilter()">
            <i class="bi bi-funnel me-1"></i> Filter
          </button>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-secondary modern-btn" (click)="resetFilter()">
            <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Skeleton Loading -->
  <div *ngIf="showSkeleton" class="skeleton-container">
    <div class="skeleton-table">
      <div class="skeleton-header">
        <div class="skeleton-cell" *ngFor="let i of [1,2,3,4,5,6,7,8,9]"></div>
      </div>
      <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10]">
        <div class="skeleton-cell" *ngFor="let j of [1,2,3,4,5,6,7,8,9]"></div>
      </div>
    </div>
  </div>

  <!-- Reports Table -->
  <div *ngIf="!showSkeleton" class="table-container" data-aos="fade-up">
    <div class="table-header">
      <h3 class="table-title">
        <i class="bi bi-table me-2"></i>
        Reports List
      </h3>
      <div class="table-info">
        Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
        {{ Math.min(currentPage * itemsPerPage, totalItems) }} of {{ totalItems }} reports
      </div>
    </div>

    <div class="modern-table-wrapper">
      <table class="table modern-table">
        <thead>
          <tr>
            <th><i class="bi bi-building me-1"></i> Site Name</th>
            <th><i class="bi bi-geo-alt me-1"></i> Province</th>
            <th><i class="bi bi-briefcase me-1"></i> Company</th>
            <th><i class="bi bi-person me-1"></i> Agent</th>
            <th><i class="bi bi-calendar-event me-1"></i> Planned Date</th>
            <th><i class="bi bi-calendar-check me-1"></i> Actual Date</th>
            <th><i class="bi bi-flag me-1"></i> Status</th>
            <th><i class="bi bi-check-circle me-1"></i> Submitted</th>
            <th><i class="bi bi-gear me-1"></i> Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let report of pagedReports; let i = index" 
              class="table-row" 
              [style.animation-delay]="(i * 0.05) + 's'">
            <td class="site-name">
              <div class="site-info">
                <strong>{{ report.report?.site?.name || 'N/A' }}</strong>
                <small class="site-id">ID: {{ report.report?.site?.siteId || 'N/A' }}</small>
              </div>
            </td>
            <td>{{ report.report?.site?.province || 'N/A' }}</td>
            <td>
              <span class="vendor-badge">{{ getVendorName(report) }}</span>
            </td>
            <td>{{ report.report?.fme?.fullName || report.report?.fmeName || 'N/A' }}</td>
            <td>
              <span class="date-badge">
                {{ report.report?.pmPlannedDate | date: 'dd/MM/yyyy' }}
              </span>
            </td>
            <td>
              <span class="date-badge" *ngIf="report.report?.pmActualDate">
                {{ report.report?.pmActualDate | date: 'dd/MM/yyyy' }}
              </span>
              <span class="text-muted" *ngIf="!report.report?.pmActualDate">N/A</span>
            </td>
            <td>
              <span [ngClass]="getStatusBadgeClass(report.report?.status)">
                {{ report.report?.status || 'N/A' }}
              </span>
            </td>
            <td>
              <div class="submission-status">
                <i class="bi" 
                   [ngClass]="report.report?.isSubmitted ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger'">
                </i>
                <span [ngClass]="report.report?.isSubmitted ? 'text-success' : 'text-danger'">
                  {{ report.report?.isSubmitted ? 'Yes' : 'No' }}
                </span>
              </div>
            </td>
            <td>
              <button
                class="btn btn-action"
                (click)="voirRapport(report)"
                title="View report"
              >
                <i class="bi bi-eye"></i>
              </button>
            </td>
          </tr>
          
          <!-- Empty State -->
          <tr *ngIf="pagedReports.length === 0" class="empty-row">
            <td colspan="9" class="text-center py-5">
              <div class="empty-state">
                <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                <h5 class="text-muted">No reports found</h5>
                <p class="text-muted">Try adjusting your search or filter criteria</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modern Pagination -->
  <div class="pagination-container" *ngIf="totalPages > 1 && !showSkeleton" data-aos="fade-up">
    <nav aria-label="Report pagination">
      <ul class="modern-pagination">
        <!-- Previous Button -->
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link prev-next" (click)="changePage(currentPage - 1)">
            <i class="bi bi-chevron-left"></i>
            <span class="d-none d-sm-inline">Previous</span>
          </button>
        </li>
        
        <!-- Page Numbers -->
        <li class="page-item" 
            *ngFor="let page of getVisiblePages()" 
            [class.active]="currentPage === page"
            [class.dots]="page === -1">
          <button class="page-link" 
                  *ngIf="page !== -1" 
                  (click)="changePage(page)">
            {{ page }}
          </button>
          <span class="page-dots" *ngIf="page === -1">...</span>
        </li>
        
        <!-- Next Button -->
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link prev-next" (click)="changePage(currentPage + 1)">
            <span class="d-none d-sm-inline">Next</span>
            <i class="bi bi-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
    
    <!-- Pagination Info -->
    <div class="pagination-info">
      <span>Page {{ currentPage }} of {{ totalPages }}</span>
      <span class="separator">â€¢</span>
      <span>{{ totalItems }} total reports</span>
    </div>
  </div>

</main>

<app-footer></app-footer>
